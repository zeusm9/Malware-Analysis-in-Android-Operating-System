import constants as const
import csv
import os

MANIFEST_DICT = {
    const.S1: 'feature',
    const.S2: 'permission',
    const.S3: ['activity', 'service_receiver', 'provider', 'service'],
    const.S4: 'intent',
    const.S5: 'api_call',
    const.S6: 'real_permission',
    const.S7: 'call',
    const.S8: 'url',
}

def get_labeled_dataset(features_list,data_size):
    labeled_dataset = open('drebin/dataset.txt','w')

    with open(const.MALWARES_PATH,mode="r") as malwares:
        reader = csv.reader(malwares,delimiter=',')
        next(reader,None)
        malware_dict = {rows[0]:rows[1] for rows in reader}

    apps = os.listdir(const.APPS_PATH)
    for app in apps[:data_size]:
        labeled_dataset.write(malware_dict.get(app,"safeware") + '\t' +get_features(app,dict((k,MANIFEST_DICT[k]) for k in features_list if k in MANIFEST_DICT))  + '\n')
    return labeled_dataset

def get_features(app,features_dict):

    with open(const.APPS_PATH + '/' + app) as file:
        feature = ''
        for line in file:
            line = line.strip()
            line = line.split('::')
            if line[0] in features_dict.values():
                feature = ' '.join([feature,line[1]])
    return feature[1:]


